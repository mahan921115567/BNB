<!-- Floating Action Button -->
<div class="fixed bottom-24 sm:bottom-6 left-6 z-[100]">
    <button (click)="toggleChat()" class="bg-amber-400 hover:bg-amber-500 text-black shadow-lg shadow-amber-500/30 rounded-full w-16 h-16 flex items-center justify-center transition-transform transform hover:scale-110 relative">
        @if (isOpen()) {
            <!-- Close Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        } @else {
            <!-- Chat Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        }
        <!-- Unread Badge -->
        @if (unreadCount() > 0 && !isOpen()) {
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-6 w-6 flex items-center justify-center border-2 border-white dark:border-gray-900 animate-bounce">{{ unreadCount() }}</span>
        }
    </button>
</div>

<!-- Chat Window -->
@if (isOpen()) {
    <div class="fixed bottom-44 sm:bottom-24 left-6 z-[99] w-[calc(100vw-3rem)] max-w-sm h-[60vh] max-h-[500px] bg-gray-50 dark:bg-gray-950 rounded-2xl shadow-2xl flex flex-col border border-gray-200 dark:border-gray-800 animate-fade-in">
        <!-- Header -->
        <header class="p-4 bg-white/50 dark:bg-gray-900/50 backdrop-blur-md border-b border-gray-200 dark:border-gray-800/50 text-center rounded-t-2xl">
            <h3 class="text-lg font-bold text-amber-500 dark:text-amber-400">پشتیبانی آنلاین</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400">
                @if(isGuest()) {
                    در خدمت شما هستیم
                } @else {
                    خوش آمدید، {{ currentUser()?.username }}
                }
            </p>
        </header>

        <!-- Messages -->
        <main #chatMessagesContainer class="flex-grow p-4 space-y-4 overflow-y-auto">
             @if (messages().length === 0) {
                <div class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                    <p>چگونه می‌توانیم کمکتان کنیم؟</p>
                </div>
            } @else {
                @for (msg of messages(); track msg.id) {
                    <div class="flex" [class.justify-end]="msg.sender === 'user'" [class.justify-start]="msg.sender === 'expert'">
                        <div class="max-w-[85%] p-3 rounded-2xl" 
                             [class.bg-amber-400]="msg.sender === 'user'" 
                             [class.text-black]="msg.sender === 'user'" 
                             [class.rounded-br-lg]="msg.sender === 'user'"
                             [class.bg-white]="msg.sender === 'expert'"
                             [class.dark:bg-gray-700]="msg.sender === 'expert'"
                             [class.text-gray-900]="msg.sender === 'expert'"
                             [class.dark:text-gray-200]="msg.sender === 'expert'"
                             [class.rounded-bl-lg]="msg.sender === 'expert'">
                            <p class="text-sm leading-relaxed whitespace-pre-wrap">{{ msg.text }}</p>
                            <p class="text-xs mt-2 opacity-70 text-right">{{ msg.timestamp | date:'HH:mm' }}</p>
                        </div>
                    </div>
                }
            }
        </main>

        <!-- Input -->
        <footer class="p-2 bg-white/50 dark:bg-gray-900/50 backdrop-blur-md border-t border-gray-200 dark:border-gray-800/50 rounded-b-2xl">
            <form (ngSubmit)="sendMessage()" class="flex items-center gap-2">
                <input 
                    type="text" 
                    [(ngModel)]="newMessage"
                    name="newMessage"
                    placeholder="پیام خود را بنویسید..."
                    class="w-full p-3 bg-gray-200 dark:bg-gray-800 border border-transparent rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none transition-all">
                <button 
                    type="submit" 
                    [disabled]="!newMessage().trim()"
                    class="bg-amber-400 hover:bg-amber-500 text-black font-bold p-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </form>
        </footer>
    </div>
}